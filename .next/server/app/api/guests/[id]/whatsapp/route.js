"use strict";(()=>{var e={};e.id=806,e.ids=[806],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3263:e=>{e.exports=import("firebase-admin/app")},2929:e=>{e.exports=import("firebase-admin/firestore")},9491:e=>{e.exports=require("assert")},4300:e=>{e.exports=require("buffer")},7147:e=>{e.exports=require("fs")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},9828:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>d,requestAsyncStorage:()=>c,routeModule:()=>u,serverHooks:()=>h,staticGenerationAsyncStorage:()=>l});var o=r(2411),s=r(7081),n=r(6224),i=r(1399),p=e([i]);i=(p.then?(await p)():p)[0];let u=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/guests/[id]/whatsapp/route",pathname:"/api/guests/[id]/whatsapp",filename:"route",bundlePath:"app/api/guests/[id]/whatsapp/route"},resolvedPagePath:"C:\\Users\\jaime.andre\\Documents\\As Minhas Formas\\downloads\\gestor-convidados\\app\\api\\guests\\[id]\\whatsapp\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:c,staticGenerationAsyncStorage:l,serverHooks:h}=u,E="/api/guests/[id]/whatsapp/route";function d(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:l})}a()}catch(e){a(e)}})},1399:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{POST:()=>c,dynamic:()=>h,runtime:()=>l});var o=r(3120),s=r(1068),n=r(6596),i=r(7439),p=r(1943),d=e([s]);s=(d.then?(await d)():d)[0];let l="nodejs",h="force-dynamic";function u(e,t=500,r){return o.NextResponse.json({error:e,details:r??null},{status:t})}async function c(e,{params:t}){try{if(!process.env.WASENDER_API_KEY)return u("WASENDER_API_KEY ausente",500);if(!process.env.UPLOADTHING_TOKEN)return u("UPLOADTHING_TOKEN ausente",500);let e=await s.i.collection("guests").doc(t.id).get();if(!e.exists)return u("Convidado n\xe3o encontrado",404);let r=e.data();if(!r?.token)return u("Convidado sem token",400);let a=(0,p.S)(r.whatsapp||r.phone);if(!a)return u("WhatsApp inv\xe1lido/ausente (use formato +244...)",400);let d=await n.toBuffer(r.token,{type:"png"}),c=await (0,i.N)(d,`qr-${t.id}.png`);process.env.APP_BASE_URL;let l=`Sauda\xe7\xf5es Prezado(a) ${r.fullName}! Este \xe9 o teu C\xf3digo QR para o check-in na Imers\xe3o Jur\xeddica.
Guarde-o para usa-lo no dia do evento - dia\xa012\xa0de\xa0Setembro.
`,h=await (0,p.k)({to:a,imageUrl:c,text:l});return await e.ref.update({updatedAt:Date.now()}),o.NextResponse.json({ok:!0,imageUrl:c,provider:h},{status:200})}catch(t){let e=t?._raw||{message:t?.message||String(t)};return console.error("[whatsapp one] error:",e),u(t?.message||"Erro ao enviar WhatsApp.",502,e)}}a()}catch(e){a(e)}})},1068:(e,t,r)=>{r.a(e,async(e,a)=>{try{let i;r.d(t,{i:()=>p});var o=r(3263),s=r(2929),n=e([o,s]);if([o,s]=n.then?(await n)():n,(0,o.getApps)().length)i=(0,o.getApps)()[0];else{let e=process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g,"\n");process.env.FIREBASE_PROJECT_ID&&process.env.FIREBASE_CLIENT_EMAIL&&e||console.warn("[firebase-admin] Credenciais incompletas. APIs protegidas podem falhar."),i=(0,o.initializeApp)({credential:(0,o.cert)({projectId:process.env.FIREBASE_PROJECT_ID,clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:e})})}let p=(0,s.getFirestore)(i);a()}catch(e){a(e)}})},7439:(e,t,r)=>{r.d(t,{N:()=>o});var a=r(3111);async function o(e,t="qrcode.png"){let r=process.env.UPLOADTHING_TOKEN;if(!r)throw Error("UPLOADTHING_TOKEN em falta");try{let o=new a.VD({token:r}),s=new File([e],t,{type:"image/png"}),n=await o.uploadFiles(s),i=Array.isArray(n)?n[0]:n;if(i?.error)throw console.error("[uploadthing] provider error:",i.error),Error(String(i.error));let p=i?.data?.url;if(!p)throw Error("UploadThing n\xe3o retornou URL p\xfablica");return p}catch(e){throw console.error("[uploadthing] exception:",e),Error("Falha no upload para UploadThing: "+(e?.message||String(e)))}}},1943:(e,t,r)=>{function a(e){if(!e)return null;let t=e.replace(/[^\d+]/g,"");if(t.startsWith("+"))return t;let r=process.env.DEFAULT_COUNTRY_CODE||"244";return t.startsWith(r)?`+${t}`:`+${r}${t}`}async function o(e){let t=await e.text();try{return{ok:!0,data:t?JSON.parse(t):{}}}catch{return{ok:!1,data:t}}}async function s(e){let t=(process.env.WASENDER_BASE_URL||"https://wasenderapi.com").replace(/\/+$/,""),r=process.env.WASENDER_API_KEY;if(!r)throw Error("WASENDER_API_KEY em falta");let a=await fetch(`${t}/api/send-message`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await o(a);if(a.ok&&(s.ok&&s.data?.success!==!1||!s.ok&&a.ok)||(a=await fetch(`${t}/api/send-message`,{method:"POST",headers:{"x-api-key":r,"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await o(a),a.ok&&(s.ok&&s.data?.success!==!1||!s.ok&&a.ok)))return s.ok?s.data:{raw:s.data};let n=Error((s.ok?s.data?.error?.message||s.data?.message:String(s.data))||`Falha no envio WhatsApp (HTTP ${a.status})`);throw n._raw={status:a.status,body:s.ok?s.data:{text:s.data}},n}async function n({to:e,imageUrl:t,text:r}){try{return await s({to:e,imageUrl:t,text:r})}catch{return await s({to:e,type:"image",url:t,caption:r})}}r.d(t,{S:()=>a,k:()=>n})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[860,642,596,111],()=>r(9828));module.exports=a})();