"use strict";(()=>{var e={};e.id=365,e.ids=[365],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3263:e=>{e.exports=import("firebase-admin/app")},2929:e=>{e.exports=import("firebase-admin/firestore")},9491:e=>{e.exports=require("assert")},4300:e=>{e.exports=require("buffer")},7147:e=>{e.exports=require("fs")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},3401:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>c,requestAsyncStorage:()=>d,routeModule:()=>l,serverHooks:()=>h,staticGenerationAsyncStorage:()=>u});var o=r(2411),s=r(7081),n=r(6224),i=r(183),p=e([i]);i=(p.then?(await p)():p)[0];let l=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/guests/send-all/route",pathname:"/api/guests/send-all",filename:"route",bundlePath:"app/api/guests/send-all/route"},resolvedPagePath:"C:\\Users\\jaime.andre\\Documents\\As Minhas Formas\\downloads\\gestor-convidados\\app\\api\\guests\\send-all\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:d,staticGenerationAsyncStorage:u,serverHooks:h}=l,g="/api/guests/send-all/route";function c(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:u})}a()}catch(e){a(e)}})},183:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{POST:()=>l,dynamic:()=>u,runtime:()=>d});var o=r(3120),s=r(1068),n=r(6596),i=r(7439),p=r(1943),c=e([s]);s=(c.then?(await c)():c)[0];let d="nodejs",u="force-dynamic";async function l(){try{let e=(await s.i.collection("guests").get()).docs.map(e=>({id:e.id,...e.data()})),t=process.env.APP_BASE_URL||"http://localhost:3000",r=0,a=0,c=0,l=null;for(let o of e)try{let e=(0,p.S)(o.whatsapp||o.phone);if(!e||!o.token){a++;continue}let s=await n.toBuffer(o.token,{type:"png"}),c=await (0,i.N)(s,`qr-${o.id}.png`),l=`Ol\xe1 ${o.fullName}! Este \xe9 o teu QR para check-in.
${t}/checkin?token=${encodeURIComponent(o.token)}`;await (0,p.k)({to:e,imageUrl:c,text:l}),r++}catch(e){c++,l=e?._raw||{message:e?.message||String(e)}}return o.NextResponse.json({ok:!0,sent:r,skipped:a,failed:c,lastError:l})}catch(e){return console.error("[whatsapp all] error:",e),o.NextResponse.json({error:e.message||"Erro no envio em massa do WhatsApp."},{status:500})}}a()}catch(e){a(e)}})},1068:(e,t,r)=>{r.a(e,async(e,a)=>{try{let i;r.d(t,{i:()=>p});var o=r(3263),s=r(2929),n=e([o,s]);if([o,s]=n.then?(await n)():n,(0,o.getApps)().length)i=(0,o.getApps)()[0];else{let e=process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g,"\n");process.env.FIREBASE_PROJECT_ID&&process.env.FIREBASE_CLIENT_EMAIL&&e||console.warn("[firebase-admin] Credenciais incompletas. APIs protegidas podem falhar."),i=(0,o.initializeApp)({credential:(0,o.cert)({projectId:process.env.FIREBASE_PROJECT_ID,clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:e})})}let p=(0,s.getFirestore)(i);a()}catch(e){a(e)}})},7439:(e,t,r)=>{r.d(t,{N:()=>o});var a=r(3111);async function o(e,t="qrcode.png"){if(!process.env.UPLOADTHING_SECRET&&!process.env.UPLOADTHING_TOKEN)throw Error("UPLOADTHING_SECRET/UPLOADTHING_TOKEN em falta");try{let r=new a.VD,o=new File([new Uint8Array(e)],t,{type:"image/png"}),s=await r.uploadFiles(o),n=Array.isArray(s)?s[0]:s;if(n?.error)throw console.error("[uploadthing] provider error:",n.error),Error(String(n.error));let i=n?.data?.url;if(!i)throw Error("UploadThing n\xe3o retornou URL p\xfablica");return i}catch(e){throw console.error("[uploadthing] exception:",e),Error("Falha no upload para UploadThing: "+(e?.message||String(e)))}}},1943:(e,t,r)=>{function a(e){if(!e)return null;let t=e.replace(/[^\d+]/g,"");if(t.startsWith("+"))return t;let r=process.env.DEFAULT_COUNTRY_CODE||"244";return t.startsWith(r)?`+${t}`:`+${r}${t}`}async function o(e){let t=await e.text();try{return{ok:!0,data:t?JSON.parse(t):{}}}catch{return{ok:!1,data:t}}}async function s(e){let t=(process.env.WASENDER_BASE_URL||"https://wasenderapi.com").replace(/\/+$/,""),r=process.env.WASENDER_API_KEY;if(!r)throw Error("WASENDER_API_KEY em falta");let a=await fetch(`${t}/api/send-message`,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await o(a);if(a.ok&&(s.ok&&s.data?.success!==!1||!s.ok&&a.ok)||(a=await fetch(`${t}/api/send-message`,{method:"POST",headers:{"x-api-key":r,"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await o(a),a.ok&&(s.ok&&s.data?.success!==!1||!s.ok&&a.ok)))return s.ok?s.data:{raw:s.data};let n=Error((s.ok?s.data?.error?.message||s.data?.message:String(s.data))||`Falha no envio WhatsApp (HTTP ${a.status})`);throw n._raw={status:a.status,body:s.ok?s.data:{text:s.data}},n}async function n({to:e,imageUrl:t,text:r}){try{return await s({to:e,imageUrl:t,text:r})}catch{return await s({to:e,type:"image",url:t,caption:r})}}r.d(t,{S:()=>a,k:()=>n})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[860,642,596,111],()=>r(3401));module.exports=a})();